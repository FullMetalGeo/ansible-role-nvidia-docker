---
# tasks file for nvidia-docker
- include_tasks: cuda_driver.yml

- name: Ensure Nvidia-Docker v1.x volumes are removed
  docker_volume:
    driver: nvidia-docker
    name: "*"
    state: absent

- name: Ensure Nvidia-Docker v1.x is Removed
  package:
    name: nvidia-docker
    state: absent

- name: Download Nvidia Driver (CentOS/RHEL)
  get_url:
    dest: /etc/yum.repos.d/nvidia-docker.repo
    url: "https://nvidia.github.io/nvidia-docker/{{ ansible_distribution | lower }}{{ ansible_distribution_major_version }}/nvidia-docker.repo"

- name: Install Nvidia-Docker
  package:
    name: nvidia-docker2
    state: latest

- name: Configure default runtime
  lineinfile:
    insertbefore: '\"runtimes\":\s\{'
    line: '    default-runtime": "nvidia",'
    path: /etc/docker/daemon.json

- name: Kill existing docker process
  shell: "pkill -SIGHUP dockerd"

- name: Test gpu container
  command: "docker run --runtime=nvidia --rm nvidia/cuda nvidia-smi"
